## Task & Definition
- task: TODO 2025-09-29.12 – finish Neo4j migration for backup/maintenance unit tests.
- deliverables: refactor BackupService/MaintenanceService tests to Neo4j helpers, clean realistic mocks, capture passing targeted tests.
- status: initiated 2025-09-29T20:50Z.

## Constraints/Risks
- project enforces path-depth and alias policies; test helpers must obey.
- Falkor references may still exist in shared mocks; removing them could break other suites if not coordinated.
- test command output must be redirected to logs per repo policy.

## Code Searches
- 2025-09-29T20:52Z — `rg "Falkor" tests/unit/services/BackupService.test.ts tests/unit/services/MaintenanceService.test.ts tests/test-utils/realistic-mocks.ts` to map remaining Falkor-era references; confirmed heavy usage in backup/maintenance suites and absence in mocks implementation.
- 2025-09-29T20:55Z — `rg "DatabaseServiceDeps" packages -n` to verify available DI hooks and confirm qdrant factory absence, informing helper approach.
- 2025-09-29T21:12Z — `rg "mockResolvedValue" tests/unit/services/MaintenanceService.test.ts` while updating graph query stubs to the new { data: [] } structure.

## Web Searches
- none required (local refactor).

## Implementation Notes
- 20:58Z — Added `applyQdrantMock` helper in `tests/test-utils/realistic-mocks.ts` to centralize qdrant injection, ensuring `getQdrantClient/getQdrantService` return the installed mock for Neo4j-backed tests.
- 21:04Z — Refactored `BackupService.test.ts` to build Neo4j/Postgres/Redis mocks via DI-friendly config (no qdrant in DB service config), applied helper-based qdrant injection across scenarios, and renamed graph-focused cases to clarify legacy Falkor artifact naming.
- 21:18Z — Updated `MaintenanceService.test.ts` to use Neo4j config, remove `@ts-nocheck`, attach qdrant mock, and reshape `falkordbQuery` expectations to the `{ data: [...] }` graph result contract; simplified relationship assertions to align with current service behavior.
- 21:32Z — Stabilized Postgres interactions in backup tests by stubbing deterministic schema/data responses and overriding `healthCheck`, eliminating random failures from `RealisticPostgreSQLMock`.

## Validation Evidence
- 21:36Z — `pnpm vitest --run tests/unit/services/BackupService.test.ts tests/unit/services/MaintenanceService.test.ts --reporter=basic` (output redirected). All suites green; see `logs/latest-test.log` for run details and Vitest reporter warning about basic output deprecation.

## Open Follow-ups
- none currently.
