# Task & Definition
- Task: TODO.md item 20 — Remove file-level object-injection disables in @memento/core services [ID: 2025-09-30.40].
- Definition of Done:
  - Eliminate `/* eslint-disable security/detect-object-injection */` from the listed core files.
  - Refactor dynamic indexing to safe patterns (Object.fromEntries, Map, `.at()` or guarded access) without changing behavior.
  - Add spot tests for session update paths that build dynamic hashes.
  - `pnpm -s lint` has no error-level occurrences for the listed files and no unused-disable warnings.

# Constraints/Risks
- Keep changes minimal; avoid deep refactors.
- Monorepo depth and import rules (no new deep paths; prefer reuse; no new packages).
- Lint noise in other packages may fail global lint; verify targeted files explicitly.

# Code Searches
- Locate disables in core:
  - Command: `rg -n "^/\\* eslint-disable security/detect-object-injection \\*/" packages/core`
  - Result: 11 files matched initially (all entry points listed by the task).
- Identify safe helper precedent:
  - File: `packages/core/src/rollback/DiffEngine.ts` (safe get/set helpers)
  - Takeaway: Prefer `.at()`, `Object.fromEntries`, `Object.getOwnPropertyDescriptor` to avoid dynamic sinks.

# Web Searches
- None (not required).

# Implementation Notes
- Removed file-level disables in all listed files.
- Refactors (highlights):
  - EnhancedSessionStore: build Redis payloads via `Object.fromEntries`; wrapped `case 'delete'` in braces.
  - SessionMigration: same `Object.fromEntries` pattern.
  - SessionAnalytics: `Object.fromEntries` for agent updates; replaced timeframe map with `switch`.
  - SessionHealthCheck: percentile access via `.at()`; parseRedisInfo via `Object.fromEntries`.
  - SessionBridge: Cypher alias `start.id as startId`; replaced object record counters with `Map` → `Object.fromEntries`; array access via `.at()`.
  - SnapshotManager: deep clone via entries; size via `Buffer.byteLength`.
  - FileWatcher: replaced `pattern[i]` with `pattern.charAt(i)`.
  - Rollback strategies: replace array indexing with `.at()`; wrap `case 'manual'` block; remove disables.

# Validation Evidence
- Removed disables:
  - Command: `rg -n "^/\\* eslint-disable security/detect-object-injection \\*/" packages/core | wc -l`
  - Result: 0
- Targeted ESLint on listed files:
  - Log: logs/latest-lint-core-targeted.log
  - Summary: 0 errors, warnings remain unrelated to object-injection.
- Unit tests (spot tests for dynamic hash builders):
  - File: tests/unit/services/EnhancedSessionStore.update-hash.test.ts
  - Run: `pnpm vitest run tests/unit/services/EnhancedSessionStore.update-hash.test.ts --reporter=basic > logs/latest-test.log 2>&1`
  - Result: 2 passed.

# Open Follow-ups
- Consider centralizing safe access helpers in `@memento/utils` for reuse (safeGet/safeSet) and migrating other packages (see TODO.md item 21). 
- Remaining ESLint warnings (e.g., `no-explicit-any`) are out of scope for this task.
