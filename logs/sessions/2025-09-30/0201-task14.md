# Task & Definition
Implement TODO.md Task 14 [ID: 2025-09-30.1]: Reconcile shared-type exports blocking workspace type-check. Fix missing/incorrect exports in `@memento/shared-types`, update API imports to use canonical types, and get `pnpm exec tsc -p tsconfig.test.json --noEmit` closer to green. Scope limited to export mismatches and immediate API type wiring.

# Constraints/Risks
- Monorepo path mapping points to package `src` (not `dist`); barrel exports must be correct.
- Avoid circular deps: `@memento/shared-types` should not depend on higher-level packages.
- tRPC generics are sensitive; minimal casting may be needed to unblock type-check.
- KnowledgeGraphService route methods have drifted; out of scope for this session.

# Code Searches
- rg missing exports in log: see `logs/typecheck-2025-09-30_task14.log` and subsequent passes (`-2`, `-3`, `-4`, `-5`, `-6`).
- rg symbols:
  - `APIGatewayConfig` -> packages/shared-types/src/api-types.ts:142
  - `ApiKeyRegistry` -> packages/shared-types/src/api-types.ts:212
  - `CoverageMetrics` -> exported in shared-types and re-exported by core types
  - `AuthContext` -> packages/shared-types/src/auth.ts
  - WebSocket types -> packages/shared-types/src/websocket-types.ts
  - Local scope types -> packages/api/src/middleware/scope-catalog.ts

# Web Searches
- None (network restricted). Not required for this task.

# Implementation Notes
- Shared-types barrel (`packages/shared-types/src/index.ts`): export `APIGatewayConfig`, `SynchronizationServices`, `ApiKeyRecord`, `ApiKeyRegistry`, `ApiKeyVerification`, `AuthErrorDetails`, `ErrorContext`, `ErrorMetadata`, `StandardErrorResponse`, `TimeRangeParams`, and scope types (`ScopeRequirement`, `ScopeRule`).
- Normalize scope types: update `packages/shared-types/src/api-types.ts` `ScopeRule`/`ScopeRequirement` to match API usage (RegExp matcher, method?, scopes, mode?).
- API imports:
  - Use `AuthContext` from `@memento/shared-types` in `APIGateway.ts`, trpc base/router, websocket-router.
  - Use WebSocket types from `@memento/shared-types` directly in `websocket-router.ts`.
  - In `mcp-router.ts`, import `CoverageMetrics` from `@memento/shared-types` (keep `Spec` from `@memento/core`).
  - Fix `DatabaseService` imports in API routes to `@memento/database` (admin/docs/security/graph-subgraph/trpc base).
- Fastify augmentation: add `packages/api/src/types/fastify.d.ts` and reference it via `/// <reference path="./types/fastify.d.ts" />` in `APIGateway.ts`.
- Scope catalog: consume shared `ScopeRule`/`ScopeRequirement` and keep default rules/local catalog implementation.
- Testing package: export `SpecNotFoundError` and `TestPlanningValidationError` from `packages/testing/src/index.ts`.
- Minimal tRPC/array typing fixes: annotate `any[]` for admin/code/graph routes where inference produced `never[]`.
- Temporary casts to avoid cross-package nominal type friction:
  - Cast `syncCoordinator`, `syncMonitor`, `conflictResolver` to `any` at APIGateway call sites.

# Validation Evidence
- Ran: `pnpm exec tsc -p tsconfig.test.json --noEmit` multiple times; logs captured:
  - logs/typecheck-2025-09-30_task14.log (baseline)
  - logs/typecheck-2025-09-30_task14-2.log
  - logs/typecheck-2025-09-30_task14-3.log
  - logs/typecheck-2025-09-30_task14-4.log
  - logs/typecheck-2025-09-30_task14-5.log
  - logs/typecheck-2025-09-30_task14-6.log (current)
- Results: All original missing-export errors for `APIGatewayConfig`, `ApiKeyRegistry`, `CoverageMetrics`, `AuthContext`, and WebSocket types are resolved. Current failures are unrelated to shared-type export issues (tRPC generics, KG route method drift, test mocks). See the latest log for details.

# Open Follow-ups
- TODO.md item 2025-09-30.F1: Align tRPC route handler typings to v10 generics to remove `as any` casts in `packages/api/src/routes/trpc-design.ts` and fix `never[]` in other tRPC routes.
- TODO.md item 2025-09-30.F2: Update `packages/api/src/routes/vdb.ts` to current `KnowledgeGraphService` API (rename methods and adjust metrics accessors) and add minimal wrapper shims if needed.
- TODO.md item 2025-09-30.F3: Define a shared `SynchronizationEventBus` interface in `@memento/shared-types` capturing EventEmitter methods to remove `as any` casts for sync services and WebSocket router.
- TODO.md item 2025-09-30.F4: Improve test mocks for `KnowledgeGraphService`, `DatabaseService`, and `ASTParser` to satisfy structural typing in `packages/api/tests/*` without loosening types.
- TODO.md item 2025-09-30.F5: Consider adding a root `types.d.ts` that is included by the test tsconfig to host ambient augmentations (e.g., Fastify), avoiding file-level references.
