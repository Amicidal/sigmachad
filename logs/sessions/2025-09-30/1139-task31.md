# Task & Definition
- Implement TODO Task 31: CacheManager Generics Cleanup [ID: 2025-09-30.18].
- Goal: Remove unknown/any propagation by making CacheManager caches explicitly typed; ensure typed access to CachedFileInfo fields; add focused unit tests.

# Constraints/Risks
- Must avoid any/unknown casts around CacheManager.
- Keep LRU behavior without breaking Map methods used by clients (e.g., forEach).
- Respect monorepo depth/import rules.

# Code Searches
- Command: rg -n "CacheManager Generics Cleanup" TODO.md — Locate task entry.
- Command: sed -n '560,700p' TODO.md — Read Task 31 details.
- Command: rg -n "CachedFileInfo|ExportMapEntry" packages/knowledge — Trace types and usages.
- Command: nl -ba packages/knowledge/src/orchestration/CacheManager.ts | sed -n '240,320p' — Pinpoint error site from logs.
- Observation: fileCache.forEach used; previous LRU returned an object lacking Map.forEach; also found as any/unknown casts.

# Web Searches
- None (offline; not required).

# Implementation Notes
- Refactored PerformanceOptimizer.createLRUCache to return a real Map subclass overriding set/get/delete/clear; preserves all Map methods (including forEach/values/size).
- Removed unknown cast in CacheManager constructor; now directly uses typed LRU Map.
- Eliminated as any casts in CacheManager index maintenance; rely on SymbolEntity shape.
- Added unit tests at tests/unit/knowledge/CacheManager.unit.test.ts to validate stats and update flows.

# Validation Evidence
- Will run: pnpm exec tsc -p packages/knowledge/tsconfig.json --noEmit > logs/typecheck-task31.log 2>&1
- Will run: pnpm exec vitest run tests/unit/knowledge/CacheManager.unit.test.ts --reporter=basic > logs/latest-test.log 2>&1
- Expect: no TS errors in CacheManager; tests passing show typed access works.

# Open Follow-ups
- Consider tightening CachedFileInfo.symbolMap value type from any -> SymbolEntity in shared-types if acceptable blast radius.
- Assess additional callers (ASTParserCore) for redundant caches now that CacheManager is reliable.
- If broader refactor required, split into follow-up tasks.
\n## Validation Evidence (Appended)
- Typecheck run: logs/typecheck-task31.log — contains unrelated ingestion errors; CacheManager compiles and tests run.
- Unit test: logs/latest-test.log — 1 file, 2 tests passed.
\n## Implementation Notes (Task 34)
- Updated WorkerPool.registerHandler signature to accept TaskPayload['type'] instead of WorkerConfig['type'] to align handler keys with task types ('parse', 'entity_upsert', 'relationship_upsert', 'embedding').
- Narrowed getAvailableWorker param to TaskPayload['type'] and leveraged existing fallback to any idle worker when a handler exists.
- No runtime behavior change; preserves handler dispatch and worker selection logic; compiles clean.
\n## Validation Evidence (Task 34)
- Typecheck after fix: logs/typecheck-task34-after-fix.log (empty = success).
- Re-ran targeted unit test: logs/latest-test.log remains green.
\n## Open Follow-ups
- See TODO.md items 2025-09-30.20 (symbolMap typing) for a safe tightening that can be done next.
