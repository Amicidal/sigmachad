# Task 23: Composite References + Export Paths Fix

## Task & Definition
- Address TS6305 errors caused by mismatches between TypeScript composite project outputs and package.json exports in Nx-built packages.
- Make @memento/shared-types, @memento/core, @memento/database, @memento/parser consumable via project references and package exports.
- Verify knowledge package compiles past TS6305 issues (accept non-TS6305 type errors for now).

## Constraints/Risks
- Nx copies package.json into each dist/; export paths must be relative to dist/.
- tsconfig.base.json defines global path aliases to src/, which can conflict with composite/project-references expectations.
- Build caching (tsbuildinfo) can mask missing outputs after cleaning dist/.

## Code Searches
- rg tsconfig + outDir/rootDir/references across packages to map settings
  - Command: `rg -n "tsconfig(\\.lib)?\\.json|composite|declarationDir|outDir|rootDir|references" packages -S`
  - Result: many libs use `rootDir: ./src`, `outDir: ./dist`; shared-types uses that; core/database composite true.
- Prior session log (other agent): packages/parser/logs/sessions/2025-09-29_2300-task23.md reviewed to understand prior fixes and open items.

## Web Searches
- Skipped; leveraged local evidence and prior session notes. (No external API/standards changes required.)

## Implementation Notes
- core: ensured declarations existed by forcing fresh build (remove dist + tsbuildinfo), which produced dist/index.d.ts as expected.
- database: switched package.json exports from src/*.ts to compiled js/d.ts and kept wildcard subpath export.
- parser: switched package.json exports to compiled js/d.ts for both `.` and `./builders`; added wildcard subpath export. Enabled composite + declaration in tsconfig for reference builds.
- knowledge: added path overrides to prefer compiled dist for @memento/{parser,core,database,graph}; added parser to `references`.
- Builds executed with outputs redirected:
  - logs/build-core-task23.log (clean rebuild confirmed index.d.ts emitted)
  - logs/build-parser-task23.log (no errors)
  - logs/build-database-task23.log (no errors)
  - logs/typecheck-knowledge-task23.log (TS6305 cleared; remaining type-level errors noted below)

## Validation Evidence
- Parser build errors: none (see logs/build-parser-task23.log)
- Database build errors: none (see logs/build-database-task23.log)
- Knowledge typecheck: TS6305 resolved. Remaining errors are type/interface and module shape issues (e.g., PathAnalyzer type mismatch; missing exports in @memento/graph models; local module imports). See logs/typecheck-knowledge-task23.log.

## Open Follow-ups
1. Decide on unified strategy for path aliases vs. project references across the monorepo (src vs dist). Consider scoping overrides in per-package tsconfigs to avoid global churn.
2. @memento/graph: verify exports for models-ogm include `modelToEntity`, `entityToModelProps` or update imports accordingly.
3. knowledge: resolve remaining type mismatches (Entity vs. specific variants) and local alias imports (`@memento/knowledge/...`).
4. Optional cleanup: remove duplicate parser builder sources outside `src/builders/` if obsolete, to reduce confusion and output duplication.
5. After changes, run full Nx build to ensure copied dist/package.json contains correct exports (CI step).
