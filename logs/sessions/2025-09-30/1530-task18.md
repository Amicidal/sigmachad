Task & Definition
- Implement Task 18 (ID: 2025-09-30.5): Fix tRPC handler typings and array inference across API routes, replacing any/never[] with proper types and removing `as any` casts in the specified files.

Constraints/Risks
- Workspace uses Nx/project references; running `tsc` on a single package can surface unrelated upstream build-state errors (TS6305/TS6059). Avoid introducing new cross-package type dependencies from route files.
- Keep ESM compatibility; avoid non-ESM-only imports that would break runtime.
- Acceptance scoped to the four route files, not the entire workspace type-check.

Code Searches
- rg -n "trpc|never\[]|any\[\]" packages/api/src -S
  - Goal: find any/never[] usages and target routes.
  - Result: any[] in trpc-admin.ts, trpc-code.ts, trpc-graph.ts; casts in trpc-design.ts.
- nl/sed inspections of: packages/api/src/routes/trpc-*.ts
  - Goal: locate exact lines for fixes.

Web Searches
- None (internal refactor only).

Implementation Notes
- trpc-design.ts
  - Removed imports from @memento/testing and @memento/core to avoid TS6305/TS6059.
  - Added local DTOs inferred from Zod and `SpecServiceLike` interface.
  - Implemented `ensureSpecService()` using `createRequire(import.meta.url)` to lazy-load `@memento/testing` at runtime and avoid compile-time coupling.
  - Converted handlers to `await ensureSpecService(...)`; removed trailing casts.
- trpc-graph.ts
  - Introduced local `GraphRelationship` type; removed `any[]` arrays.
  - Fixed dedupe with typed `limit`.
  - Replaced enum imports with string comparisons; pruned `nativeEnum` usage to keep file self-contained.
- trpc-code.ts
  - Added `RefactorSuggestion` with `RefactorKind`/`RefactorImpact` unions; removed `any[]`.
- trpc-admin.ts
  - Typed log level/component via `as const` unions + generic picker.
  - Annotated `SyncResult`; typed `result: SyncResult` to retain literal types.
  - Mapped `mode` â†’ Neo4j benchmark options, removing `as any`.

Validation Evidence
- Ran focused type-check and captured logs:
  - Command: `pnpm exec tsc -p packages/api/tsconfig.json --noEmit > logs/latest-typecheck-api.log 2>&1`
  - Filter: `rg -n "packages/api/src/routes/trpc-(design|graph|code|admin)\\.ts|TS2345|never\\[\\]" logs/latest-typecheck-api.log`
  - Result: 0 matches for `as any`/`never[]`/`TS2345` within the four files. Remaining errors are unrelated (testing/shared-types build-state), tracked elsewhere.
- Grep confirmation for casts/arrays:
  - Command: `rg -n "as any|never\\[\\]|any\\[\\]" packages/api/src/routes/trpc-design.ts packages/api/src/routes/trpc-graph.ts packages/api/src/routes/trpc-code.ts packages/api/src/routes/trpc-admin.ts -S`
  - Result: No matches.

Open Follow-ups
- None for Task 18. Note: broader workspace type-check is still blocked by shared-types build output mismatch (Task 2025-09-30.10) and testing package exposure. See TODO.md Task 23.
