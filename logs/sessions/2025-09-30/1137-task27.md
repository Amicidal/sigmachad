Task & Definition
Continue Task 27 (Ingestion Event Typing Convergence) to standardize ingestion event payloads and listeners. Deliverables: unify `metrics:updated` to `PipelineMetrics`, introduce queue-scoped metrics event, replace `parse:error` with `pipeline:error` across producers/consumers/tests, and add typed emitter helper to enforce payloads.

Constraints/Risks
- Monorepo rules: depth ≤3 levels; ESM paths only; pnpm-based.\
- Knowledge package has broader type errors (see TODO items 2025-09-29.8 + splits); avoid expanding scope beyond event typing.\
- Tests are noisy; per repo guidance, capture logs to files if running. Network restricted.

Code Searches
- rg -n "parse:error|metrics:updated|pipeline:error|queue:metrics" packages
  Goal: find all event producers/consumers.\
  Result: `parse:error` listeners in `packages/knowledge/scripts/smoke-test.ts` and `packages/knowledge/tests/integration/pipeline-integration.test.ts`. `metrics:updated` emitted from pipeline, error-handler, performance-monitor, and queue-manager. No `queue:metrics` yet.

Web Searches
- None (network restricted and not required for this task).

Implementation Notes
- Added `packages/shared-types/src/typed-event-emitter.ts` with `TypedEventEmitter<Events>` interface; exported from `shared-types` index.\
- Extended `IngestionEvents` in `packages/shared-types/src/ingestion-types.ts` with `'queue:metrics': [QueueMetrics]`.\
- QueueManager: now `implements TypedEventEmitter<IngestionEvents>` and emits `'queue:metrics'` (was `'metrics:updated'` with a cast).\
- Pipeline: now `implements TypedEventEmitter<IngestionEvents>`; listens to `'queue:metrics'` and continues emitting canonical `'metrics:updated'` with `PipelineMetrics`.\
- WorkerPool and IngestionErrorHandler: applied `TypedEventEmitter` for compile-time enforcement (no runtime change).\
- Replaced `parse:error` listeners with `pipeline:error` in `scripts/smoke-test.ts` and `tests/integration/pipeline-integration.test.ts`; adjusted pushed event types accordingly.\
- Left `performance-monitor.ts` as-is (separate class, non-IngestionEvents). Follow-up possible to rename to `perf:metrics` and bridge into `PipelineMetrics` if needed.
 - Bridged performance metrics: instantiated `PerformanceMonitor` in pipeline, started/stopped with pipeline lifecycle; instrumented `file_parse` via `startOperation`/`endOperation`; mapped queue/worker summaries into the monitor; on monitor `perf:metrics` (renamed from `metrics:updated`), fed `avg`/`p95` latency into `PipelineMetrics` and emitted an immediate `metrics:updated` tick.

Update (2025-09-30 11:42 UTC)
- Renamed PerformanceMonitor event `metrics:updated` → `perf:metrics`; updated pipeline subscription accordingly.

Validation Evidence
- Search confirmation: `rg -n "parse:error" packages` → no results.\
- Search confirmation: `rg -n "queue:metrics" packages` → events emitted in queue-manager and consumed in pipeline.\
- Type safety: classes now `implements TypedEventEmitter<IngestionEvents>`; compile-time enforcement for `on/emit` signatures (tests not executed due to broader type errors tracked in TODO 2025-09-29.8 splits).
 - Bridge checks: `rg -n "perfMonitor\." packages/knowledge/src/ingestion/pipeline.ts` shows start/stop, queue/worker updates, parse instrumentation, and metrics feed.

Open Follow-ups
- If/when knowledge package type errors are addressed (Tasks 2025-09-30.2/3/4), run focused Vitest suites and capture logs under `logs/latest-test.log` to validate event payloads at runtime.\
- Optional: normalize `performance-monitor.ts` events to `perf:metrics` and add a mapper into `PipelineMetrics` (new subtask if desired).\
- Optional: add unit tests that assert compile-time typing for `emit/on` via dts-style checks or `// @ts-expect-error` probes.
