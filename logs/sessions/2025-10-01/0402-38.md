Task & Definition
- Task 38: Decouple unit tests from external services [ID: 2025-10-01.3]. Ensure unit suites run fully offline/deterministic and use integration gating for live paths.

Constraints/Risks
- Must keep monorepo import/depth rules intact.
- Avoid breaking existing unit mocks; prefer additive/global mocks.
- Network access restricted; cannot spin containers here. Validate via targeted runs and logs.
- Some unit tests intentionally simulate connection failures; their error logs are expected and not real connections.

Code Searches
- Command: rg -n "^###\\s*38\\." TODO.md → Located task spec at lines ~638.
- Command: find tests/unit -type f → Reviewed unit suite layout; identified services, API, knowledge tests.
- Command: rg -n "neo4j|qdrant|redis|DatabaseService" tests -S → Confirmed existing mocks and potential touchpoints.
- Command: rg -n "vitest.config|setupFiles" → Root vitest config uses tests/setup.ts and excludes tests/integration unless RUN_INTEGRATION=1.

Web Searches
- None (offline).

Implementation Notes
- Added offline module mocks in tests/setup.ts guarded by RUN_INTEGRATION:
  - neo4j-driver: stubbed driver/session/tx; prevents live Neo4j connections.
  - @qdrant/js-client-rest: stubbed QdrantClient; prevents live vector DB calls.
- Updated tests/README.md:
  - Clarified offline unit runs and RUN_INTEGRATION=1 gating.
  - Documented docker-compose path for integration services (tests/e2e/docker-compose.test.yml).
  - Simplified run commands (offline unit, targeted, and integration).
- Left pg/redis global mocks to per-test control to avoid conflicts with existing detailed mocks.

Validation Evidence
- Ran a focused subset offline and captured logs:
  - Command: pnpm -s vitest run tests/unit/services/DatabaseService.test.ts tests/unit/services/PostgreSQLService.test.ts tests/unit/services/RedisService.test.ts tests/unit/services/QdrantService.test.ts > logs/latest-test.log 2>&1
  - Tail (50–80 lines) inspected; no real connection attempts observed. Qdrant/Neo4j are satisfied by global mocks. Two assertion failures remain (API mismatch in DatabaseService tests), unrelated to external connections.
  - Note: Error strings like "Connection failed" in the log are from intentionally simulated failures inside unit tests (e.g., PostgreSQLService and RedisService negative paths), not from live services.

Open Follow-ups
- Task 39 (Align unit tests with current APIs) will address DatabaseService test expectation mismatches (extra options argument to neo4j.query and cleanup semantics) seen in this run.
- If future unit tests start using raw pg/redis without local mocks, consider adding opt-in global mocks for those modules as well (guarded like current ones) to maintain offline guarantees.
