# Task & Definition
Resolve remaining security/detect-object-injection violations in @memento/knowledge per TODO.md task 37 [ID: 2025-10-01.2]. Target the entry points listed and replace dynamic indexing with validated accessors or Maps; add line-scoped disables only where inputs are already strictly validated. Add minimal unit coverage around refactored paths.

# Constraints/Risks
- Must adhere to monorepo rules (depth, imports, boundaries).
- Avoid changing public APIs unless clearly internal; prefer internal refactors that keep return types consistent.
- High-volume lint output; capture logs to files, not chat.
- Rule can flag even safe array indexing; prefer structural iteration techniques.

# Code Searches
- Command: pnpm -s exec eslint 'packages/knowledge/src/**/*.ts' --max-warnings=-1 --no-error-on-unmatched-pattern > logs/latest-eslint-knowledge.log 2>&1
- Goal: Confirm current violations and line numbers.
- Result: 11 error-level security/detect-object-injection found. See Validation Evidence for excerpts.

# Web Searches
- None. Internal codebase task.

# Implementation Notes
- Pending.

# Validation Evidence
- ESLint log saved to logs/latest-eslint-knowledge.log. Excerpts for security/detect-object-injection:
  - packages/knowledge/src/orchestration/StatsCollector.ts:194 (two findings)
  - packages/knowledge/src/orchestration/SyncOrchestrator.ts:428, 433 (two), 434
  - packages/knowledge/src/parsing/ASTParser.ts:4366, 4388
  - packages/knowledge/src/parsing/DirectoryHandler.ts:56, 78
  - packages/knowledge/src/utils.ts:64

# Open Follow-ups
- None yet.

## Implementation Notes (continued)
- StatsCollector.computeBatchStats: replaced dynamic `stats[id] = ...` writes by accumulating results in `Map<string, EntityEdgeStats>` and returning `Object.fromEntries(...)`. Also paired ids to results using `Promise.all` over `[id, result]` tuples to avoid array indexing of `batchResults`.
- SyncOrchestrator.findMatchedSections: removed `lines[i]`/`lines[j]` indexing; now iterates with `lines.entries()` and searches a reversed slice window for headers using string tests.
- ASTParser.buildDirectoryEntities: switched to `segments.entries()` and pairwise linking via rolling `previous` pointer; derived `lastDirId` without indexing.
- DirectoryHandler.createDirectoryHierarchy: mirrored the ASTParser changes to avoid dynamic indexing in entity creation, adjacency linking, and last-dir to file linking.
- utils.detectLanguage: converted object literal to `Map` and used `.get()` to eliminate `languageMap[extension]` access.

## Validation Evidence (continued)
- Targeted ESLint before fixes: logs/latest-eslint-knowledge.log (11 errors for security/detect-object-injection under packages/knowledge). Example lines recorded in the session header.
- Targeted ESLint after fixes: logs/latest-eslint-knowledge.after2.log shows 0 errors for security/detect-object-injection under packages/knowledge.
- Workspace lint: logs/latest-lint.after-fix.log contains no error-level `security/detect-object-injection` for packages/knowledge.
- Focused unit tests: logs/latest-test-knowledge-focused.log â€” 2 files, 3 tests passed; validated DirectoryHandler relationships and utils.detectLanguage behavior.
